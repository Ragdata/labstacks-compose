# name: Chaskiq
# description: Messaging platform for marketing, support and sales â€” Rails-based self-hosted customer messaging and automation.
# category: cms
# tags: chaskiq, messaging, chat, marketing, support, sales, rails, redis, postgresql, sidekiq
# website: https://chaskiq.io
# docs: https://chaskiq.io/docs
# repo: https://github.com/chaskiq/chaskiq
---
services:

  chaskiq:
    image: chaskiq/chaskiq:latest
    container_name: chaskiq
    hostname: chaskiq
    restart: unless-stopped
    environment:
      - SERVICE_URL_CHASKIQ_3000
      - REDIS_URL=redis://redis:6379/
      - DATABASE_URL=postgres://$SERVICE_USER_POSTGRES:$SERVICE_PASSWORD_POSTGRES@postgresql:5432/${POSTGRES_DB:-chaskiq}
      - POSTGRES_USER=$SERVICE_USER_POSTGRES
      - SERVICE_URL=${SERVICE_URL_CHASKIQ}
      - HOST=${SERVICE_URL_CHASKIQ_3000}
      - ASSET_HOST=${SERVICE_URL_CHASKIQ_3000}
      - WS=wss://${SERVICE_URL_CHASKIQ}/cable
      - SNS_CONFIGURATION_SET=metrics
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_S3_BUCKET=${AWS_S3_BUCKET:-}
      - AWS_S3_REGION=${AWS_S3_REGION:-}
      - ADMIN_EMAIL=${ADMIN_EMAIL:-admin@example}
      - ADMIN_PASSWORD=${SERVICE_PASSWORD_ADMIN}
      - DEFAULT_SENDER_EMAIL=${DEFAULT_SENDER_EMAIL:-admin@example}
      - LOCAL_STORAGE_PATH=/data/storage
      - ACTIVE_STORAGE_SERVICE=${ACTIVE_STORAGE_SERVICE:-local}
      - SMTP_DELIVERY_METHOD=${SMTP_DELIVERY_METHOD:-}
      - SMTP_ADDRESS=${SMTP_ADDRESS:-}
      - SMTP_USERNAME=${SMTP_USERNAME:-}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-}
      - CHASKIQ_APPSTORE_TOKEN=${CHASKIQ_APPSTORE_TOKEN:-}
      - APP_ENV=production
      - RAILS_ENV=production
      - RACK_ENV=production
      - RAILS_SERVE_STATIC_FILES=true
      - SECRET_KEY_BASE=${SERVICE_PASSWORD_64_SECRET}
      - RAILS_LOG_TO_STDOUT=true
      - ENABLED_AUDITS=true
      - TZ=${TIMEZONE:-UTC}
    entrypoint: ["/entrypoint.sh"]
    depends_on:
      postgresql:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - chaskiq-storage:/data/storage
      - ${REPODIR}/entrypoint.sh:/entrypoint.sh
    networks:
      - chaskiq
    ports:
      - 3000:3000
    healthcheck:
      test: ["CMD", "curl", "-f", "http://chaskiq:3000"]
      interval: 5s
      timeout: 20s
      retries: 15

  sidekiq:
    image: chaskiq/chaskiq:latest
    container_name: sidekiq
    hostname: sidekiq
    restart: unless-stopped
    environment:
      - REDIS_URL=redis://redis:6379/
      - DATABASE_URL=postgres://$SERVICE_USER_POSTGRES:$SERVICE_PASSWORD_POSTGRES@postgresql:5432/${POSTGRES_DB:-chaskiq}
      - POSTGRES_USER=$SERVICE_USER_POSTGRES
      - HOST=${SERVICE_URL_CHASKIQ_3000}
      - ASSET_HOST=${SERVICE_URL_CHASKIQ_3000}
      - WS=wss://${SERVICE_URL_CHASKIQ}/cable
      - SNS_CONFIGURATION_SET=metrics
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_S3_BUCKET=${AWS_S3_BUCKET:-}
      - AWS_S3_REGION=${AWS_S3_REGION:-}
      - ADMIN_EMAIL=${ADMIN_EMAIL:-admin@example}
      - ADMIN_PASSWORD=${SERVICE_PASSWORD_ADMIN}
      - DEFAULT_SENDER_EMAIL=${DEFAULT_SENDER_EMAIL:-admin@example}
      - LOCAL_STORAGE_PATH=/data/storage
      - ACTIVE_STORAGE_SERVICE=${ACTIVE_STORAGE_SERVICE:-local}
      - SMTP_DELIVERY_METHOD=${SMTP_DELIVERY_METHOD:-}
      - SMTP_ADDRESS=${SMTP_ADDRESS:-}
      - SMTP_USERNAME=${SMTP_USERNAME:-}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-}
      - CHASKIQ_APPSTORE_TOKEN=${CHASKIQ_APPSTORE_TOKEN:-}
      - APP_ENV=production
      - RAILS_ENV=production
      - RACK_ENV=production
      - RAILS_SERVE_STATIC_FILES=true
      - SECRET_KEY_BASE=$SERVICE_PASSWORD_64_SECRET
      - RAILS_LOG_TO_STDOUT=true
      - ENABLED_AUDITS=true
      - TZ=${TIMEZONE:-UTC}
    volumes:
      - chaskiq-storage:/data/storage
    depends_on:
      postgresql:
        condition: service_healthy
      redis:
        condition: service_healthy
      chaskiq:
        condition: service_healthy
    command: ["bundle", "exec", "sidekiq", "-C", "config/sidekiq.yml"]
    networks:
      - chaskiq
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "bundle exec rails runner 'puts Sidekiq.redis(&:info)' > /dev/null 2>&1",
        ]
      interval: 5s
      timeout: 10s
      retries: 15

  postgresql:
    image: postgres:14-alpine
    container_name: chaskiq-db
    hostname: chaskiq-db
    restart: unless-stopped
    volumes:
      - postgresql-data:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=$SERVICE_USER_POSTGRES
      - POSTGRES_PASSWORD=$SERVICE_PASSWORD_POSTGRES
      - POSTGRES_DB=${POSTGRES_DB:-chaskiq}
      - POSTGRES_INITDB_ARGS= --data-checksums
      - PSQL_HISTFILE=/root/log/.psql_history
    networks:
      - chaskiq
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 10

  redis:
    image: redis:6-alpine
    container_name: chaskiq-redis
    hostname: chaskiq-redis
    restart: unless-stopped
    volumes:
      - redis-data:/data
    networks:
      - chaskiq
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 10

volumes:
  chaskiq-storage:
    name: chaskiq-storage
    driver: local
  postgresql-data:
    name: postgresql-data
    driver: local
  redis-data:
    name: redis-data
    driver: local

networks:
  chaskiq:
    name: chaskiq
    driver: bridge
